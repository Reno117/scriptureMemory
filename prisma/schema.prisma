generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "mysql"
}

model User {
  id            String    @id
  name          String    @db.Text
  email         String    @unique
  role          String    @default("driver")
  // driver | sponsor | admin

  emailVerified Boolean   @default(false)
  image         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  accounts      Account[]
  driverProfile DriverProfile?
  sponsorUser   SponsorUser?
  
  // Audit trail relations
  pointChangesGiven PointChange[] @relation("PointChanger")
  applicationReviews DriverApplication[] @relation("ApplicationReviewer")

  @@map("user")
}

model DriverProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sponsorId     String?
  sponsor       Sponsor? @relation(fields: [sponsorId], references: [id], onDelete: SetNull)
  
  pointsBalance Int      @default(0)
  status        String   @default("pending")
  // pending | active | dropped

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  applications  DriverApplication[]
  pointChanges  PointChange[]
  cart          Cart?     // NEW - one cart per driver
  orders        Order[]   // NEW

  @@map("driver_profile")
}

model Sponsor {
  id          String   @id @default(cuid())
  name        String
  pointValue  Float    @default(0.01) // dollar value per point
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  drivers         DriverProfile[]
  sponsorUsers    SponsorUser[]
  applications    DriverApplication[]
  pointChanges    PointChange[]
  catalogProducts CatalogProduct[]  // NEW
  orders          Order[]           // NEW

  @@map("sponsor")
}

model SponsorUser {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sponsorId  String
  sponsor    Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("sponsor_user")
}

model DriverApplication {
  id            String   @id @default(cuid())
  driverProfileId String
  driverProfile DriverProfile @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  
  sponsorId     String
  sponsor       Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  status        String   @default("pending")
  // pending | approved | rejected
  
  reason        String?  @db.Text
  reviewedBy    String?
  reviewer      User?    @relation("ApplicationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("driver_application")
}

model PointChange {
  id              String   @id @default(cuid())
  driverProfileId String
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  
  sponsorId       String
  sponsor         Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  amount          Int
  reason          String   @db.Text
  
  changedBy       String
  changedByUser   User     @relation("PointChanger", fields: [changedBy], references: [id], onDelete: Restrict)
  
  createdAt       DateTime @default(now())

  @@index([driverProfileId])
  @@index([sponsorId])
  @@index([createdAt])
  @@map("point_change")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.Text
  userAgent String?  @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String    @db.Text
  providerId            String    @db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model CatalogProduct {
  id          String   @id @default(cuid())
  sponsorId   String
  sponsor     Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  ebayItemId  String   // eBay's unique item ID (from their API)
  title       String   @db.Text
  imageUrl    String?  @db.Text
  price       Float    // ADD THIS - USD price from eBay

  
  isActive    Boolean  @default(true) // Sponsor can hide without deleting
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([sponsorId, ebayItemId]) // Prevent duplicate items in same sponsor's catalog
  @@index([sponsorId])
  @@map("catalog_product")
}

model Cart {
  id              String   @id @default(cuid())
  driverProfileId String   @unique
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           CartItem[]
  
  @@map("cart")
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  ebayItemId      String
  title           String   @db.Text
  imageUrl        String?  @db.Text
  pointPrice      Int      // Points at time of adding to cart (snapshot)
  quantity        Int      @default(1)
  
  createdAt       DateTime @default(now())
  
  @@index([cartId])
  @@map("cart_item")
}

model Order {
  id              String   @id @default(cuid())
  driverProfileId String
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id])
  
  sponsorId       String
  sponsor         Sponsor  @relation(fields: [sponsorId], references: [id])
  
  totalPoints     Int      // Total points spent on this order
  status          String   @default("pending")
  // pending | processing | shipped | delivered | cancelled
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           OrderItem[]
  
  @@index([driverProfileId])
  @@index([sponsorId])
  @@index([status])
  @@map("order")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  ebayItemId  String
  title       String   @db.Text
  imageUrl    String?  @db.Text
  pointPrice  Int      // Points per item at time of purchase
  quantity    Int
  
  createdAt   DateTime @default(now())
  
  @@index([orderId])
  @@map("order_item")
}