generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "mysql"
}

model User {
  id            String    @id
  name          String    @db.Text
  email         String    @unique
  role          String    @default("driver")
  // driver | sponsor | admin

  emailVerified Boolean   @default(false)
  image         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  accounts      Account[]
  driverProfile DriverProfile?
  sponsorUser   SponsorUser?
  
  // Audit trail relations
  pointChangesGiven PointChange[] @relation("PointChanger")
  applicationReviews DriverApplication[] @relation("ApplicationReviewer")

  verses        Verse[]   // Bible Memory app

  @@map("user")
}

model DriverProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sponsorId     String?
  sponsor       Sponsor? @relation(fields: [sponsorId], references: [id], onDelete: SetNull)
  
  pointsBalance Int      @default(0)
  status        String   @default("pending")
  // pending | active | dropped

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  applications  DriverApplication[]
  pointChanges  PointChange[]
  cart          Cart?
  orders        Order[]

  @@map("driver_profile")
}

model Sponsor {
  id          String   @id @default(cuid())
  name        String
  pointValue  Float    @default(0.01)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  drivers         DriverProfile[]
  sponsorUsers    SponsorUser[]
  applications    DriverApplication[]
  pointChanges    PointChange[]
  catalogProducts CatalogProduct[]
  orders          Order[]

  @@map("sponsor")
}

model SponsorUser {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sponsorId  String
  sponsor    Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("sponsor_user")
}

model DriverApplication {
  id            String   @id @default(cuid())
  driverProfileId String
  driverProfile DriverProfile @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  
  sponsorId     String
  sponsor       Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  status        String   @default("pending")
  // pending | approved | rejected
  
  reason        String?  @db.Text
  reviewedBy    String?
  reviewer      User?    @relation("ApplicationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("driver_application")
}

model PointChange {
  id              String   @id @default(cuid())
  driverProfileId String
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  
  sponsorId       String
  sponsor         Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  amount          Int
  reason          String   @db.Text
  
  changedBy       String
  changedByUser   User     @relation("PointChanger", fields: [changedBy], references: [id], onDelete: Restrict)
  
  createdAt       DateTime @default(now())

  @@index([driverProfileId])
  @@index([sponsorId])
  @@index([createdAt])
  @@map("point_change")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.Text
  userAgent String?  @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String    @db.Text
  providerId            String    @db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model CatalogProduct {
  id          String   @id @default(cuid())
  sponsorId   String
  sponsor     Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  
  ebayItemId  String
  title       String   @db.Text
  imageUrl    String?  @db.Text
  price       Float

  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([sponsorId, ebayItemId])
  @@index([sponsorId])
  @@map("catalog_product")
}

model Cart {
  id              String   @id @default(cuid())
  driverProfileId String   @unique
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           CartItem[]
  
  @@map("cart")
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  ebayItemId      String
  title           String   @db.Text
  imageUrl        String?  @db.Text
  pointPrice      Int
  quantity        Int      @default(1)
  
  createdAt       DateTime @default(now())
  
  @@index([cartId])
  @@map("cart_item")
}

model Order {
  id              String   @id @default(cuid())
  driverProfileId String
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id])
  
  sponsorId       String
  sponsor         Sponsor  @relation(fields: [sponsorId], references: [id])
  
  totalPoints     Int
  status          String   @default("pending")
  // pending | processing | shipped | delivered | cancelled
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           OrderItem[]
  
  @@index([driverProfileId])
  @@index([sponsorId])
  @@index([status])
  @@map("order")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  ebayItemId  String
  title       String   @db.Text
  imageUrl    String?  @db.Text
  pointPrice  Int
  quantity    Int
  
  createdAt   DateTime @default(now())
  
  @@index([orderId])
  @@map("order_item")
}

model Verse {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  reference   String
  book        String
  chapter     Int
  verse       Int
  text        String   @db.Text
  translation String   @default("NIV")
  imageUrl    String?  @db.Text

  isMemorized Boolean  @default(false)
  isSeed      Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([reference, translation])
  @@index([userId])
  @@index([book])
  @@index([isMemorized])
  @@map("verse")
}